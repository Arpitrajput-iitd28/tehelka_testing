<app-layout pageTitle="Create Test">
  <div class="create-test-container">
    <!-- Header Section -->
    <div class="page-header">
      <div class="header-content">
        <h1>Create New Load Test</h1>
        <p>Configure and launch a new performance test for your application</p>
      </div>
      <div class="header-actions">
        <button class="btn-secondary" routerLink="/tests">
          <i class="fas fa-arrow-left"></i>
          Back to Tests
        </button>
      </div>
    </div>

    <!-- Loading Projects State -->
    <div *ngIf="isLoadingProjects" class="loading-state">
      <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Loading projects...</p>
      </div>
    </div>

    <!-- Test Configuration Form -->
    <div *ngIf="!isLoadingProjects" class="form-container">
      <form [formGroup]="createTestForm" (ngSubmit)="createTest()" class="test-form">
        
        <!-- Basic Information -->
        <div class="form-section">
          <h2>Basic Information</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="testName">Test Name *</label>
              <input type="text" id="testName" formControlName="testName" 
                     placeholder="Enter test name" class="form-input">
              <div *ngIf="createTestForm.get('testName')?.invalid && createTestForm.get('testName')?.touched" 
                   class="error-message">
                Test name is required
              </div>
            </div>
            
            <div class="form-group">
              <label for="projectId">Project *</label>
              <select id="projectId" formControlName="projectId" (change)="onProjectChange()" class="form-select">
                <option value="">Select a project</option>
                <option *ngFor="let project of projects" [value]="project.id">{{project.name}}</option>
              </select>
              <div *ngIf="createTestForm.get('projectId')?.invalid && createTestForm.get('projectId')?.touched" 
                   class="error-message">
                Please select a project
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="comments">Comments</label>
            <textarea id="comments" formControlName="comments" 
                      placeholder="Describe what this test will validate" 
                      class="form-textarea" rows="3"></textarea>
          </div>
        </div>

        <!-- Test Configuration -->
        <div class="form-section">
          <h2>Test Configuration</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="testType">Test Type *</label>
              <select id="testType" formControlName="testType" (change)="onTestTypeChange()" class="form-select">
                <option value="load">Load Test</option>
                <option value="stress">Stress Test</option>
                <option value="spike">Spike Test</option>
                <option value="volume">Volume Test</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="action">Action</label>
              <input type="text" id="action" formControlName="action" 
                     placeholder="Test action description" class="form-input" readonly>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="thread">Thread Group</label>
              <input type="text" id="thread" formControlName="thread" 
                     placeholder="Thread Group" class="form-input">
            </div>
            
            <div class="form-group">
              <label for="virtualUsers">Virtual Users *</label>
              <input type="number" id="virtualUsers" formControlName="virtualUsers" 
                     placeholder="Number of concurrent users" class="form-input" min="1" max="10000">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="duration">Duration (minutes) *</label>
              <input type="number" id="duration" formControlName="duration" 
                     placeholder="Test duration" class="form-input" min="1" max="1440">
            </div>
            
            <div class="form-group">
              <label for="rampUpTime">Ramp-up Time (seconds) *</label>
              <input type="number" id="rampUpTime" formControlName="rampUpTime" 
                     placeholder="Time to reach full load" class="form-input" min="1">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="loop">Loop Count *</label>
              <input type="number" id="loop" formControlName="loop" 
                     placeholder="Number of iterations" class="form-input" min="1">
            </div>
            
            <div class="form-group">
              <label for="startdelay">Start Delay (seconds)</label>
              <input type="number" id="startdelay" formControlName="startdelay" 
                     placeholder="Delay before starting" class="form-input" min="0">
            </div>
          </div>
        </div>

        <!-- Advanced Configuration -->
        <div class="form-section">
          <h2>Advanced Configuration</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="startupTime">Startup Time (seconds) *</label>
              <input type="number" id="startupTime" formControlName="startupTime" 
                     placeholder="Thread startup time" class="form-input" min="1">
            </div>
            
            <div class="form-group">
              <label for="holdLoadFor">Hold Load For (seconds) *</label>
              <input type="number" id="holdLoadFor" formControlName="holdLoadFor" 
                     placeholder="Duration to maintain load" class="form-input" min="1">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="shutdownTime">Shutdown Time (seconds) *</label>
              <input type="number" id="shutdownTime" formControlName="shutdownTime" 
                     placeholder="Thread shutdown time" class="form-input" min="1">
            </div>
            
            <div class="form-group">
              <label for="startThreadCount">Start Thread Count *</label>
              <input type="number" id="startThreadCount" formControlName="startThreadCount" 
                     placeholder="Initial thread count" class="form-input" min="1">
            </div>
          </div>

          <div class="form-group">
            <label for="initialDelay">Initial Delay (seconds)</label>
            <input type="number" id="initialDelay" formControlName="initialDelay" 
                   placeholder="Initial delay before test starts" class="form-input" min="0">
          </div>
        </div>

        <!-- Test Script Upload -->
        <div class="form-section">
          <h2>Test Script *</h2>
          <div class="file-upload-section">
            <div class="file-upload-area" (click)="fileInput.click()" 
                 (dragover)="onDragOver($event)" (drop)="onDrop($event)">
              <input #fileInput type="file" (change)="onFileSelected($event)" 
                     accept=".jmx,.pdf" style="display: none;">
              <i class="fas fa-cloud-upload-alt"></i>
              <p>Click to upload or drag and drop</p>
              <small>Supported formats: JMX, PDF</small>
            </div>
            <div *ngIf="selectedFile" class="selected-file">
              <i class="fas fa-file"></i>
              <span>{{selectedFile.name}}</span>
              <button type="button" (click)="removeFile()" class="remove-file-btn">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div *ngIf="!selectedFile" class="file-requirement">
              <i class="fas fa-exclamation-triangle"></i>
              <span>A JMX or PDF file is required to create the test</span>
            </div>
          </div>
        </div>

        <!-- Scheduling -->
        <div class="form-section">
          <h2>Scheduling</h2>
          <div class="schedule-options">
            <div class="schedule-option">
              <input type="radio" id="runNow" name="scheduleType" value="now" 
                     (change)="onScheduleTypeChange('now')" checked>
              <label for="runNow">Run Immediately</label>
            </div>
            <div class="schedule-option">
              <input type="radio" id="scheduleTest" name="scheduleType" value="scheduled" 
                     (change)="onScheduleTypeChange('scheduled')">
              <label for="scheduleTest">Schedule for Later</label>
            </div>
          </div>
          
          <div *ngIf="selectedScheduleType === 'scheduled'" class="schedule-datetime">
            <div class="form-group">
              <label for="scheduleTime">Schedule Date & Time</label>
              <input type="datetime-local" id="scheduleTime" formControlName="scheduleTime" 
                     class="form-input">
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="button" class="btn-secondary" routerLink="/tests">
            Cancel
          </button>
          <button type="button" class="btn-outline" (click)="saveAsDraft()">
            Save as Draft
          </button>
          <button type="submit" class="btn-primary" [disabled]="createTestForm.invalid || isCreating || !selectedFile">
            <span *ngIf="!isCreating">Create & Run Test</span>
            <span *ngIf="isCreating">
              <i class="fas fa-spinner fa-spin"></i>
              Creating Test...
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>
</app-layout>
